trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "*"
pr:
  branches:
    include: 
      - main
  paths:
    include:
      - "*"

pool:
  vmImage: "ubuntu-18.04"

stages:
  - stage: "ansible_test"
    displayName: "ansible runtime testing"
    jobs:
      - job: "test"
        displayName: "ansible-test"
        steps:
          - task: Bash@3
            displayName: "molecule test"
            inputs:
              targetType: "inline"
              script: |
                echo "hello, world! from molecule test"

  - stage: "ansible_check"
    displayName: "ansible runtime checking"
    jobs:
      - job: "check"
        pool: "Azure Self-Hosted"
        displayName: "ansible-check"
        steps:
          - bash: "hostname"
            displayName: "check host"
          - bash: "ls && pwd"
            displayName: "check pwd"
              
          - task: Ansible@0
            inputs:
              ansibleInterface: "remoteMachine"
              connectionOverSsh: "rdp03-ansible-agent-ssh-service-connection"
              playbookSourceRemoteMachine: "agentMachine"
              playbookRootRemoteMachine: "$(System.DefaultWorkingDirectory)/ansible-node-test"
              playbookPathLinkedArtifactOnRemoteMachine: "nginx-configs.yaml"
              inventoriesRemoteMachine: "file"
              inventoryFileSourceRemoteMachine: "agentMachine"
              inventoryFileLinkedArtifactOnRemoteMachine: "dev/inventory"
              args: "-CD --tags gearbox --limit iweb2.arnoldclark.com"
              
  - stage: "ansible_runtime"
    displayName: "ansible runtime provisioning"
    jobs:
      - job: "deploy"
        pool: "Azure Self-Hosted"
        displayName: "ansible-playbook"
        steps:
          - task: Bash@3
            displayName: "ansible-playbook"
            inputs:
              targetType: "inline"
              script: |
                echo "hello, world! from ansible-playbook"
